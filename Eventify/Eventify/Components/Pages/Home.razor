@page "/home"
@inject NavigationManager NavigationManager
@inject IEstadoService estadoService
@inject ICidadeService cidadeService
@inject IEventoService eventoService
@inject INotificationService NotificationService

@using Eventify.Models
@using Eventify.Core.Filtros

<div class="home-container">

    <div class="search-bar-container">
        <span class="bi bi-search search-icon" aria-hidden="true"></span>
        <input type="text"
        class="search-input"
        placeholder="Busque por eventos..."
        @bind-value="FiltroTexto"
        @onkeyup="HandleKeyup" />
        <button class="search-button" @onclick="ExecutarPesquisa">
            <i class="bi bi-arrow-right"></i>
        </button>
    </div>

    @if (IsBusy)
    {
        <div style="text-align:center; padding: 40px;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p style="margin-top: 10px; color: #666;">Buscando os melhores eventos...</p>
        </div>
    }
    else
    {
        <h2 class="section-title">Próximos eventos</h2>

        @if (listaEventosProximos == null || !listaEventosProximos.Any())
        {
            <div class="empty-state-msg">
                <p>Nenhum evento futuro encontrado no momento.</p>
            </div>
        }
        else
        {
            <div class="horizontal-scroll-container">
                @foreach (var evento in listaEventosProximos)
                {
                    <div class="event-card" @onclick="() => NavegarParaDetalhes(evento.Id)">
                        @if (!string.IsNullOrEmpty(evento.ImagemEvento))
                        {
                            <img src="@evento.ImagemEvento" alt="@evento.Titulo" class="card-image" />
                        }
                        else
                        {
                            <div class="card-image-placeholder">
                                <span>Sem Imagem</span>
                            </div>
                        }

                        <div class="card-content">
                            <h3 class="card-title">@evento.Titulo</h3>
                            <p class="card-location">
                                <i class="bi bi-geo-alt-fill"></i> @evento.Endereco?.CidadeNome
                            </p>
                            <p class="card-date">
                                <i class="bi bi-calendar"></i> @evento.DataInicio?.ToString("dd/MM")
                            </p>
                        </div>
                    </div>
                }
            </div>
        }

        <h2 class="section-title">Recomendados para você</h2>

        @if (listaEventosRecomendados == null || !listaEventosRecomendados.Any())
        {
            <div class="empty-state-msg">
                <p>Ainda não temos recomendações personalizadas.</p>
            </div>
        }
        else
        {
            <div class="horizontal-scroll-container">
                @foreach (var evento in listaEventosRecomendados)
                {
                    <div class="event-card" @onclick="() => NavegarParaDetalhes(evento.Id)">
                        @if (!string.IsNullOrEmpty(evento.ImagemEvento))
                        {
                            <img src="@evento.ImagemEvento" alt="@evento.Titulo" class="card-image" />
                        }
                        else
                        {
                            <div class="card-image-placeholder">
                                <span>Sem Imagem</span>
                            </div>
                        }
                        <div class="card-content">
                            <h3 class="card-title">@evento.Titulo</h3>
                            <p class="card-location">@evento.Endereco?.CidadeNome</p>
                            <p class="card-date">@evento.DataInicio?.ToString("dd/MM")</p>
                        </div>
                    </div>
                }
            </div>
        }

        <h2 class="section-title text-muted">Eventos Passados</h2>

        @if (listaEventosPassados == null || !listaEventosPassados.Any())
        {
            <div class="empty-state-msg">
                <p>Nenhum histórico de eventos recentes.</p>
            </div>
        }
        else
        {
            <div class="horizontal-scroll-container">
                @foreach (var evento in listaEventosPassados)
                {
                    <div class="event-card card-disabled" @onclick="() => NavegarParaDetalhes(evento.Id)">
                        <div class="image-wrapper">
                            @if (!string.IsNullOrEmpty(evento.ImagemEvento))
                            {
                                <img src="@evento.ImagemEvento" alt="@evento.Titulo" class="card-image" />
                            }
                            else
                            {
                                <div class="card-image-placeholder">
                                    <span>Sem Imagem</span>
                                </div>
                            }
                            <div class="badge-encerrado">ENCERRADO</div>
                        </div>

                        <div class="card-content">
                            <h3 class="card-title">@evento.Titulo</h3>
                            <p class="card-location">@evento.Endereco?.CidadeNome</p>
                            <p class="card-date">Realizado em: @evento.DataInicio?.ToString("dd/MM/yyyy")</p>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    private string FiltroTexto { get; set; } = string.Empty;

    // Listas separadas
    private List<EventoModel> listaEventosRecomendados = new();
    private List<EventoModel> listaEventosProximos = new();
    private List<EventoModel> listaEventosPassados = new();

    private bool IsBusy { get; set; }
    private Usuario UsuarioLogado = new();

    protected override async Task OnInitializedAsync()
    {
        UsuarioLogado = Tools.SessionTools.GetUsuarioLogado() ?? new();

        await CarregarTodosEventos();
    }

    private async Task CarregarTodosEventos()
    {
        IsBusy = true;
        try
        {
            await BuscarEventosRecomendados();
            await BuscarEventosProximos();
            await BuscarEventosPassados();
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void NavegarParaDetalhes(Guid eventoId)
    {
        try
        {
            NavigationManager.NavigateTo($"/evento/{eventoId}");
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }

    private async Task BuscarEventosProximos()
    {
        try
        {
            listaEventosProximos = new();
            var filtro = new FiltroEvento
                {
                    Titulo = FiltroTexto,
                    DataMin = DateTime.Now
                };

            var eventos = await eventoService.ObterTodosEventosAsync(filtro);

            if (eventos != null)
            {
                listaEventosProximos = eventos.Select(e => Mapping.EventoMapper.ToModel(e)).ToList();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Falha ao buscar os eventos proximos. {ex.Message}");
        }
    }

    private async Task BuscarEventosRecomendados()
    {
        try
        {
            listaEventosRecomendados = new();
            var filtro = new FiltroEvento
                {
                    Titulo = FiltroTexto,
                    OrderByMaisVendidos = true,
                    DataMin = DateTime.Now
                };

            var eventos = await eventoService.ObterTodosEventosAsync(filtro);

            if (eventos != null)
            {
                listaEventosRecomendados = eventos.Select(e => Mapping.EventoMapper.ToModel(e)).ToList();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Falha ao buscar os eventos recomendados. {ex.Message}");
        }
    }

    private async Task BuscarEventosPassados()
    {
        try
        {
            listaEventosPassados = new();
            var filtro = new FiltroEvento
                {
                    Titulo = FiltroTexto,
                    DataMax = DateTime.Now
                };

            var eventos = await eventoService.ObterTodosEventosAsync(filtro);

            if (eventos != null)
            {
                listaEventosPassados = eventos
                    .Select(e => Mapping.EventoMapper.ToModel(e))
                    .OrderByDescending(x => x.DataInicio)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Falha ao buscar os eventos passados. {ex.Message}");
        }
    }

    private async Task HandleKeyup(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ExecutarPesquisa();
        }
    }

    private async Task ExecutarPesquisa()
    {
        await CarregarTodosEventos();
    }
}