@page "/home"
@inject NavigationManager NavigationManager
@inject IEstadoService estadoService
@inject ICidadeService cidadeService
@inject IEventoService eventoService

@using Eventify.Models 

<div class="home-container">

    <div class="search-bar-container">
        <span class="bi bi-search search-icon" aria-hidden="true"></span>
        <input type="text"
               class="search-input"
               placeholder="Busque por eventos..."
               @bind-value="FiltroTexto"
               @onkeyup="HandleKeyup" />
        <button class="search-button" @onclick="ExecutarPesquisa">
            <i class="bi bi-arrow-right"></i>
        </button>
    </div>

    @if (IsBusy)
    {
        <div style="text-align:center; padding: 20px;">
            <p>Carregando eventos...</p>
        </div>
    }
    else
    {
        <h2 class="section-title">Próximos eventos</h2>

        @if (listaEventosProximos == null || !listaEventosProximos.Any())
        {
            <p style="padding:0 10px; color: #888;">Nenhum evento encontrado.</p>
        }
        else
        {
            <div class="horizontal-scroll-container">
                @foreach (var evento in listaEventosProximos)
                {
                    <div class="event-card" @onclick="() => NavegarParaDetalhes(evento.Id)">
                        @if (!string.IsNullOrEmpty(evento.ImagemEvento))
                        {
                            <img src="@evento.ImagemEvento" alt="@evento.Titulo" class="card-image" />
                        }
                        else
                        {
                            <div class="card-image" style="background-color: #eee; display:flex; align-items:center; justify-content:center;">
                                <span>Sem Imagem</span>
                            </div>
                        }

                        <div class="card-content">
                            <h3 class="card-title">@evento.Titulo</h3>
                            <p class="card-location">
                                <i class="bi bi-geo-alt-fill"></i> @evento.Endereco?.CidadeNome
                            </p>
                            <p class="card-date">
                                <i class="bi bi-calendar"></i> @evento.DataInicio?.ToString("dd/MM")
                            </p>
                        </div>
                    </div>
                }
            </div>
        }

        <h2 class="section-title">Recomendados para você</h2>

        @if (listaEventosRecomendados == null || !listaEventosRecomendados.Any())
        {
            <p style="padding:0 10px; color: #888;">Nenhum evento recomendado.</p>
        }
        else
        {
            <div class="horizontal-scroll-container">
                @foreach (var evento in listaEventosRecomendados)
                {
                    <div class="event-card" @onclick="() => NavegarParaDetalhes(evento.Id)">
                        @if (!string.IsNullOrEmpty(evento.ImagemEvento))
                        {
                            <img src="@evento.ImagemEvento" alt="@evento.Titulo" class="card-image" />
                        }
                        else
                        {
                            <div class="card-image" style="background-color: #eee; display:flex; align-items:center; justify-content:center;">
                                <span>Sem Imagem</span>
                            </div>
                        }
                        <div class="card-content">
                            <h3 class="card-title">@evento.Titulo</h3>
                            <p class="card-location">@evento.Endereco?.CidadeNome</p>
                            <p class="card-date">@evento.DataInicio?.ToString("dd/MM")</p>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@code{
    private string FiltroTexto { get; set; } = string.Empty;
    private List<EventoModel> listaEventosRecomendados = new();
    private List<EventoModel> listaEventosProximos = new();
    private List<EventoModel> listaEventosPorDescricao = new();
    private bool IsBusy { get; set; }
    private Usuario UsuarioLogado = new();


    protected override async Task OnInitializedAsync()
    {
        UsuarioLogado = Tools.SessionTools.GetUsuarioLogado() ?? new();

        await BuscarEventosRecomendados();

        await BuscarEventosProximos();
    }

    private void NavegarParaDetalhes(Guid eventoId)
    {
        try
        {
            NavigationManager.NavigateTo($"/evento/{eventoId}");
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
        }
    }

    private async Task BuscarEventosRecomendados()
    {
        try
        {
            IsBusy = true;

            listaEventosRecomendados = new();

            var eventosRecomendados = await eventoService.ObterTodosEventosAsync(new Core.Filtros.FiltroEvento
                {
                //EstadoId = UsuarioLogado.Endereco.Cidade.EstadoId,
                    OrderByMaisVendidos = true
                });

            if (eventosRecomendados != null && eventosRecomendados.Count > 0)
            {
                foreach (var item in eventosRecomendados)
                {
                    listaEventosRecomendados.Add(Mapping.EventoMapper.ToModel(item));
                }
            }
        }
        catch
        {
            //TRATAR ERRO
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task BuscarEventosProximos()
    {
        try
        {
            IsBusy = true;

            listaEventosProximos = new();

            var eventosProximos = await eventoService.ObterTodosEventosAsync(new Core.Filtros.FiltroEvento
            {
                //CidadeId = UsuarioLogado.Endereco.CidadeId,
            });

            if (eventosProximos != null && eventosProximos.Count > 0)
            {
                foreach (var item in eventosProximos)
                {
                    listaEventosProximos.Add(Mapping.EventoMapper.ToModel(item));
                }
            }
        }
        catch
        {
            //TRATAR ERRO
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task HandleKeyup(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ExecutarPesquisa();
        }
    }

    private async Task ExecutarPesquisa()
    {
        try
        {
            IsBusy = true;

            if (string.IsNullOrWhiteSpace(FiltroTexto))
            {
                await BuscarEventosRecomendados();
                await BuscarEventosProximos();
                return;
            }

            listaEventosProximos = new();
            var eventosProximos = await eventoService.ObterTodosEventosAsync(new Core.Filtros.FiltroEvento
                {
                //CidadeId = UsuarioLogado.Endereco.CidadeId,
                    Titulo = FiltroTexto,
                });

            if (eventosProximos != null && eventosProximos.Count > 0)
            {
                foreach (var item in eventosProximos)
                {
                    listaEventosProximos.Add(Mapping.EventoMapper.ToModel(item));
                }
            }

            listaEventosRecomendados = new();
            var eventosRecomendados = await eventoService.ObterTodosEventosAsync(new Core.Filtros.FiltroEvento
                {
                //EstadoId = UsuarioLogado.Endereco.Cidade.EstadoId,
                    OrderByMaisVendidos = true,
                    Titulo = FiltroTexto,
                });

            if (eventosRecomendados != null && eventosRecomendados.Count > 0)
            {
                foreach (var item in eventosRecomendados)
                {
                    listaEventosRecomendados.Add(Mapping.EventoMapper.ToModel(item));
                }
            }
        }
        catch
        {
            //TRATAR ERRO
        }
        finally
        {
            IsBusy = false;
            StateHasChanged();
        }
    }
}