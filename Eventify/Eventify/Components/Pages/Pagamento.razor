@page "/pagamento"
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject Models.States.PedidoStateService PedidoService
@inject IIngressoService IngressoService
@inject INotificationService NotificationService

<div class="payment-container p-3">
    <h3>Pagamento</h3>

    <div class="payment-tabs mb-4">
        <button class="tab-button @(TipoPagamento == enTipoPagamento.Pix ? "active" : "")"
        @onclick="() => MudarTipoPagamento(enTipoPagamento.Pix)">
            PIX
        </button>
        <button class="tab-button @(TipoPagamento == enTipoPagamento.Cartao ? "active" : "")"
        @onclick="() => MudarTipoPagamento(enTipoPagamento.Cartao)">
            Cartão de Crédito
        </button>
    </div>

    @if (TipoPagamento == enTipoPagamento.Pix)
    {
        <div class="pix-container text-center">

            @if (pagamentoConfirmadoPix)
            {
                <div class="pix-success-message">
                    <h4 class="text-success">Pagamento Confirmado!</h4>
                    <p>Seu ingresso foi enviado por e-mail!</p>
                    <button class="btn btn-outline-secondary" @onclick="NavegarParaIngressos">
                        Meus Ingressos
                    </button>
                </div>
            }
            else if (estaCarregandoPix)
            {
                <div class="pix-loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Confirmando pagamento, aguarde...</p>
                </div>
            }
            else
            {
                <h4>Total a pagar: R$ @valorTotal.ToString("n2")</h4>
                <p class="mb-2">Escaneie o QR Code abaixo com seu app do banco:</p>

                <div class="qr-code-placeholder mb-3" id="qrcode-container">
                </div>

                <p>Ou use o PIX Copia e Cola:</p>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" value="@pixStringFixo" readonly />
                    <button class="btn btn-outline-secondary" type="button">Copiar</button>
                </div>

                <button class="btn btn-primary w-100 mt-2" @onclick="SimularPagamentoPix">
                    Simular Confirmação de Pagamento
                </button>
            }
        </div>
    }
    else if (TipoPagamento == enTipoPagamento.Cartao)
    {
        @if (pagamentoConfirmadoCartao)
        {
            <div class="pix-success-message text-center">
                <h4 class="text-success">Pagamento Confirmado!</h4>
                <p>Seu ingresso foi enviado por e-mail!</p>
                <button class="btn btn-outline-secondary" @onclick="NavegarParaIngressos">
                    Meus Ingressos
                </button>
            </div>
        }
        else if (estaCarregandoCartao)
        {
            <div class="pix-loading text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Processando pagamento, aguarde...</p>
            </div>
        }
        else
        {
            <div class="card-container">
                <form>
                    <div class="mb-3">
                        <label class="form-label">Nome no Cartão</label>
                        <input type="text" class="form-control" placeholder="Como impresso no cartão" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Número do Cartão</label>
                        <input type="tel" class="form-control" placeholder="0000 0000 0000 0000" id="cartao-numero" />
                    </div>
                    <div class="row">
                        <div class="col-7 mb-3">
                            <label class="form-label">Validade (MM/AA)</label>
                            <input type="text" class="form-control" placeholder="MM/AA" id="cartao-validade" />
                        </div>
                        <div class="col-5 mb-3">
                            <label class="form-label">CVV</label>
                            <input type="tel" class="form-control" placeholder="123" id="cartao-cvv" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parcelas</label>
                        <select class="form-select">
                            <option value="1">1x de R$ 120,00</option>
                            <option value="2">2x de R$ 60,00</option>
                            <option value="3">3x de R$ 40,00</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary w-100 mt-2" @onclick="SimularPagamentoCartao">
                        Confirmar Pagamento
                    </button>
                </form>
            </div>
        }
    }
</div>

<style>
    .payment-tabs {
    display: flex;
    border-bottom: 1px solid #dee2e6;
    }

    .tab-button {
    background: none;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    color: #007bff;
    border-bottom: 3px solid transparent;
    margin-bottom: -1px;
    }

    .tab-button.active {
    border-bottom-color: #007bff;
    font-weight: bold;
    color: #0056b3;
    }

    .qr-code-placeholder {
    width: 220px;
    height: 220px;
    background-color: #f8f9fa;
    border: 1px dashed #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px auto;
    border-radius: 8px;
    }

    #qrcode-container img, #qrcode-container canvas {
    width: 100% !important;
    height: 100% !important;
    padding: 10px;
    box-sizing: border-box;
    }

    .pix-loading, .pix-success-message {
    padding: 40px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    }
</style>

@code {
    enum enTipoPagamento
    {
        Pix = 0,
        Cartao = 1
    }

    private enTipoPagamento TipoPagamento;
    private string pixStringFixo = "00020126340014br.gov.bcb.pix0112123123123123520400005303986540115802BR5905Teste6006Cidade62110507123123163046CC5";

    private bool estaCarregandoPix = false;
    private bool pagamentoConfirmadoPix = false;

    private bool estaCarregandoCartao = false;
    private bool pagamentoConfirmadoCartao = false;

    private bool pedidoValido = false;
    private double valorTotal = 0;
    private bool estaCarregando = false;
    private bool pagamentoConfirmado = false;
    private Usuario UsuarioLogado;

    protected override async Task OnInitializedAsync()
    {
        UsuarioLogado = Tools.SessionTools.GetUsuarioLogado();

        if (UsuarioLogado == null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        if (PedidoService.TemPedidoValido())
        {
            pedidoValido = true;
            valorTotal = (double)PedidoService.CategoriaSelecionada.Valor * PedidoService.Quantidade;
        }
        else
        {
            pedidoValido = false;
            NavigationManager.NavigateTo("/home");
        }
    }

    private async Task FinalizarCompra()
    {
        var listaIngressosParaCriar = new List<Ingresso>();

        for (int i = 0; i < PedidoService.Quantidade; i++)
        {
            listaIngressosParaCriar.Add(new Ingresso
                {
                    EventoId = PedidoService.EventoSelecionado.Id,
                    CategoriaIngressoId = PedidoService.CategoriaSelecionada.Id,
                    UsuarioCompraId = UsuarioLogado.Id,
                    DataCompra = DateTime.Now,
                    Valido = true,
                    Codigo = Guid.NewGuid().ToString().Substring(0, 8).ToUpper()
                });
        }

        await IngressoService.CriarIngressosEmLoteAsync(listaIngressosParaCriar);

        pagamentoConfirmado = true;
        PedidoService.LimparPedido();
        NotificationService.ShowSuccess("Compra realizada com sucesso!");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && TipoPagamento == enTipoPagamento.Pix)
        {
            await JS.InvokeVoidAsync("gerarQRCode", "qrcode-container", pixStringFixo);
        }
    }

    private void NavegarParaIngressos()
    {
        NavigationManager.NavigateTo("/meus-ingressos");
    }

    private async Task MudarTipoPagamento(enTipoPagamento novoTipo)
    {
        if (TipoPagamento == novoTipo) return;

        if (novoTipo == enTipoPagamento.Cartao)
        {
            estaCarregandoPix = false;
            pagamentoConfirmadoPix = false;
        }
        else if (novoTipo == enTipoPagamento.Pix)
        {
            estaCarregandoCartao = false;
            pagamentoConfirmadoCartao = false;
        }

        TipoPagamento = novoTipo;
        await Task.Yield();

        if (TipoPagamento == enTipoPagamento.Cartao)
        {
            await JS.InvokeVoidAsync("ativarMascarasPagamento");
        }
        else if (TipoPagamento == enTipoPagamento.Pix)
        {
            await JS.InvokeVoidAsync("gerarQRCode", "qrcode-container", pixStringFixo);
        }
    }

    private async Task SimularPagamentoPix()
    {
        estaCarregandoPix = true;
        StateHasChanged();

        try
        {
            await FinalizarCompra();
            estaCarregandoPix = false;
            pagamentoConfirmadoPix = true;
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Erro ao gerar ingressos: " + ex.Message);
            estaCarregandoPix = false;
            pagamentoConfirmadoPix = false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task SimularPagamentoCartao()
    {
        estaCarregandoCartao = true;
        StateHasChanged();

        try
        {
            await FinalizarCompra();
            estaCarregandoCartao = false;
            pagamentoConfirmadoCartao = true;
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Erro ao gerar ingressos: " + ex.Message);
            estaCarregandoCartao = false;
            pagamentoConfirmadoCartao = false;
        }
        finally
        {
            StateHasChanged();
        }
    }
}